<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <title>Onshore wind potential in Germany</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js'></script>
    <script src='style.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css"
    integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"
    crossorigin="anonymous">
    <link rel="stylesheet" href="map.css">
</head>

<body>
    <div id='map'></div>
    <div class='map-overlay' id='features'>
        <h2>Onshore wind potential</h2>
        <div id='pd'>
            <p>Hover over an area for details.<br>
            Zoom to switch administrative levels.</p>
        </div>
        <div id='buttons'>
            <div class="tooltip">
                <i onclick="showInfo()" class="fas fa-info-circle"></i>
                <span class="tooltiptext">About the map</span>
            </div>
            <a class="tooltip" href="https://doi.org/10.2312/iass.2019.052" target="_blank">
                <i class="fas fa-book-open"></i>
                <span class="tooltiptext">Read publication</span>
            </a>
            <a class="tooltip" href="https://www.iass-potsdam.de/en/research-group/energy-transition-dynamics" target="_blank">
                <i class="fas fa-user-circle"></i>
                <span class="tooltiptext">Research group</span>
            </a>
            <a class="tooltip" href="https://github.com/timtroendle/out-of-sight-map/issues/new" target="_blank">
                <i class="fas fa-flag"></i>
                <span class="tooltiptext">Report an issue</span>
            </a>
        </div>
    </div>
    <div class='map-overlay' id='legend'>
        <h2>Potential is</h2>
    </div>
    <div class='map-overlay' id="info" onclick="hideInfo()">
        <div id="infotext">
            <h2>Onshore wind potential in Germany</h2>
            <p>
                Did you find an issue in the data? Please
                <a href="https://github.com/timtroendle/out-of-sight-map/issues/new">
                    report it.
                </a>
            </p>
            <p>
                © 2018-2019 Tim Tröndle, Institute for Advanced Sustainability Studies Potsdam and Institute for Environmental Decisions, ETH Zürich
            </p>
        </div>
    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoidGltdHJvZW5kbGUiLCJhIjoiY2szNjFjbjUwMGhmbjNjbXYzZ2JoenU0bSJ9.Vfwb1BD9jSL2-Wk2bCNByw';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/timtroendle/cjqhsfrmz0nb82rqcsk6z8po6',
            center: [10, 51],
            zoom: 5
        });
        map.addControl(new mapboxgl.ScaleControl({unit: 'metric'}));
        map.on('load', function() {

            styleMap(map);

            map.on('mousemove', function(e) {
            var unit = map.queryRenderedFeatures(e.point, {
                layers: ['national', 'regional', 'municipal']
            });

            if (unit.length > 0) {
                var potential = unit[0].properties.onshore_wind_mw
                if (unit[0].properties.relative_onshore_wind) {
                    var potential_600 = potential / unit[0].properties.relative_onshore_wind;
                } else {
                    var potential_600 = 0;
                }
                if (potential > 1) {
                    var potential_unit = "MW";
                } else {
                    var potential_unit = "kW";
                    potential = potential * 1000;
                    potential_600 = potential_600 * 1000;
                }
                document.getElementById('pd').innerHTML =
                    '<p>in <strong>' + unit[0].properties.name + '</strong><br> ' +
                    '<strong>' + potential.toLocaleString('en', {maximumFractionDigits : 0}) + '</strong> ' + potential_unit + ' at 1000 m<br>' +
                    '<strong>' + potential_600.toLocaleString('en', {maximumFractionDigits : 0}) + '</strong> ' + potential_unit + ' at 600 m<br>';
            } else {
                document.getElementById('pd').innerHTML = '<p>Hover over an area for details.<br>Zoom to switch administrative levels.</p>';
            }
            });

            var hoveredStateNationId =  null;
            var hoveredStateRegionId =  null;
            var hoveredStateMunicipalityId =  null;
            // When the user moves their mouse over the state-fill layer, we'll update the
            // feature state for the feature under the mouse.
            map.on("mousemove", "national", function(e) {
                if (e.features.length > 0) {
                    if (hoveredStateNationId) {
                        map.setFeatureState({source: 'national', sourceLayer: 'nationaltechnicalpotentialenvprotection1000', id: hoveredStateNationId}, { hover: false});
                    }
                    hoveredStateNationId = e.features[0].id;
                    map.setFeatureState({source: 'national', sourceLayer: 'nationaltechnicalpotentialenvprotection1000', id: hoveredStateNationId}, { hover: true});
                }
            });
            map.on("mouseleave", "national", function() {
                if (hoveredStateNationId) {
                    map.setFeatureState({source: 'national', sourceLayer: 'nationaltechnicalpotentialenvprotection1000', id: hoveredStateNationId}, { hover: false});
                }
                hoveredStateNationId =  null;
            });
            map.on("mousemove", "regional", function(e) {
                if (e.features.length > 0) {
                    if (hoveredStateRegionId) {
                        map.setFeatureState({source: 'regional', sourceLayer: 'regionaltechnicalpotentialenvprotection1000', id: hoveredStateRegionId}, { hover: false});
                    }
                    hoveredStateRegionId = e.features[0].id;
                    map.setFeatureState({source: 'regional', sourceLayer: 'regionaltechnicalpotentialenvprotection1000', id: hoveredStateRegionId}, { hover: true});
                }
            });
            map.on("mouseleave", "regional", function() {
                if (hoveredStateRegionId) {
                    map.setFeatureState({source: 'regional', sourceLayer: 'regionaltechnicalpotentialenvprotection1000', id: hoveredStateRegionId}, { hover: false});
                }
                hoveredStateRegionId =  null;
            });
            map.on("mousemove", "municipal", function(e) {
                if (e.features.length > 0) {
                    if (hoveredStateMunicipalityId) {
                        map.setFeatureState({source: 'municipal', sourceLayer: 'municipaltechnicalpotentialenvprotection1000', id: hoveredStateMunicipalityId}, { hover: false});
                    }
                    hoveredStateMunicipalityId = e.features[0].id;
                    map.setFeatureState({source: 'municipal', sourceLayer: 'municipaltechnicalpotentialenvprotection1000', id: hoveredStateMunicipalityId}, { hover: true});
                }
            });
            map.on("mouseleave", "municipal", function() {
                if (hoveredStateMunicipalityId) {
                    map.setFeatureState({source: 'municipal', sourceLayer: 'municipaltechnicalpotentialenvprotection1000', id: hoveredStateMunicipalityId}, { hover: false});
                }
                hoveredStateMunicipalityId =  null;
            });

        });

        map.getCanvas().style.cursor = 'default';

        var layers = ['above 50% from 600 m', '50% from 600m', 'below 50% from 600m', '0 at 600 m'];
        var colors = [COLOR_HIGH_POTENTIAL, COLOR_NEUTRAL, COLOR_LOW_POTENTIAL, COLOR_MISSING];

        for (i = 0; i < layers.length; i++) {
            var layer = layers[i];
            var color = colors[i];
            var item = document.createElement('div');
            var key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);
        }

        function showInfo() {
            document.getElementById("info").style.display = "block";
        }

        function hideInfo() {
            document.getElementById("info").style.display = "none";
        }
    </script>
</body>

</html>
